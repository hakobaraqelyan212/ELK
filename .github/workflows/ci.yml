name: CI (ELK micro-branches)

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches-ignore: [ "main" ]  # branch-ի վրա push-ի ժամանակ էլ կվազի
  workflow_dispatch:

jobs:
  detect:
    runs-on: self-hosted
    outputs:
      es: ${{ steps.filter.outputs.es }}
      kibana: ${{ steps.filter.outputs.kibana }}
      logstash: ${{ steps.filter.outputs.logstash }}
      pipeline: ${{ steps.filter.outputs.pipeline }}
      compose: ${{ steps.filter.outputs.compose }}
      actions: ${{ steps.filter.outputs.actions }}
    steps:
      - uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            compose:
              - 'docker-compose.yml'
              - 'compose*.yml'
              - '**/compose*.yml'
            es:
              - 'elasticsearch/**'
            kibana:
              - 'kibana/**'
            logstash:
              - 'logstash/**'
            pipeline:
              - 'logstash/pipeline/**'
            actions:
              - '.github/workflows/**'

  test_es:
    needs: detect
    if: needs.detect.outputs.es == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Start Elasticsearch
        run: |
          set -e
          docker compose up -d && \
          docker inspect elasticsearch | grep healthy >/dev/null && \echo "Elasticsearch HEALTHY" || exit 1 && \
          echo "ES OK"  && \
          docker compose down && \
          docker inspect elasticsearch && \
          echo "ES down/up OK"

  test_kibana:
    needs: detect
    if: needs.detect.outputs.kibana == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Start Kibana
        run: |
          set -e
          docker compose up -d && \
          docker inspect kibana | grep healthy >/dev/null && \echo "Kibana HEALTHY" || exit 1 && \
          echo "Kibana container OK"  && \
          docker compose down && \
          docker inspect kibana && \
          echo "Kibana down/up OK"

  test_logstash:
    needs: detect
    if: needs.detect.outputs.logstash == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Start Logstash
        run: |
          set -e
          docker compose -f logstash/logstash.yml up -d && \
          docker inspect -f '{{.State.Health.Status}}' logstash | grep healthy >/dev/null && \echo "Logstash HEALTHY" || exit 1 && \
          echo "Logstash container OK"  && \
          docker compose -f logstash/logstash.yml down  && \
          docker inspect -f '{{.State.Health.Status}}' logstash
          echo "Logstash down/up OK"

  test_pipeline:
    needs: detect
    if: needs.detect.outputs.pipeline == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Start logstash and test pipeline
        run: |
          set -e
          docker compose -f logstash/logstash.yml up -d && \
          docker inspect -f '{{.State.Health.Status}}' logstash | grep healthy >/dev/null && \echo "Logstash HEALTHY" || exit 1 && \
          echo "Logstash container OK"  && \
          docker logs logstash | grep pipeline && \
          echo "Pipeline OK (indices listed)" && \
          docker compose -f logstash/logstash.yml down  && \
          docker inspect -f '{{.State.Health.Status}}' logstash
          echo "Logstash down/up OK"

  test_compose:
    needs: detect
    if: needs.detect.outputs.compose == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Start Elasticsearch + Logstash
        run: |
          set -e
          docker compose up -d && \
          docker inspect elasticsearch | grep healthy >/dev/null && \echo "Elasticsearch HEALTHY" || exit 1 && \
          echo "Elasticsearch container OK"  && \
          docker inspect kibana | grep healthy >/dev/null && \echo "Kibana HEALTHY" || exit 1 && \
          echo "Kibana container OK"  && \
          docker inspect logstash | grep healthy >/dev/null && \echo "Logstash HEALTHY" || exit 1 && \
          echo "Logstash container OK"  && \
          docker compose down && \
          docker inspect elasticsearch && \
          docker inspect kibana && \
          docker inspect logstash && \
          echo "ES, Kibana and Logstash down/up OK"

  test_actions:
    needs: detect
    if: needs.detect.outputs.actions == 'true'
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4
      - name: Actions workflow lint (basic)
        run: |
          set -e
          ls -la .github/workflows
          echo "Workflows present"
